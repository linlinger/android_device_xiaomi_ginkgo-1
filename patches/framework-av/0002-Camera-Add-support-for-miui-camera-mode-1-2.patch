From 1b0aec0f82fc2fb1ec6bb49a781800e12a17ed22 Mon Sep 17 00:00:00 2001
From: Adithya R <gh0strider.2k18.reborn@gmail.com>
Date: Fri, 1 Jan 2021 03:07:52 +0530
Subject: [PATCH 2/3] Camera: Add support for miui camera mode [1/2]

 * devices like ginkgo and some xiaomi sdm660 use miui camera mode in camera
   hal to activate certain functions in camera hal, these are enabled when
   vendor.camera.miui.apk is set to 1 based on sys.camera.miui.apk value

 * if this prop is set by default gcam crashes, so we must do it dynamically

 * xiaomi does this in stock libcameraservice but unfortunately we don't
   have stock android 12 to use prebuilt lib

To enable, set TARGET_USES_MIUI_CAMERA := true in BoardConfig.

Change-Id: I8d9ee4e650f3e2196546570c183c9d169b8aa335
Signed-off-by: Edwiin Kusuma Jaya <kutemeikito0905@gmail.com>
---
 services/camera/libcameraservice/CameraService.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/services/camera/libcameraservice/CameraService.cpp b/services/camera/libcameraservice/CameraService.cpp
index 79fc9157bf..3118d78b04 100644
--- a/services/camera/libcameraservice/CameraService.cpp
+++ b/services/camera/libcameraservice/CameraService.cpp
@@ -38,6 +38,7 @@
 #include <aidl/AidlCameraService.h>
 #include <android-base/macros.h>
 #include <android-base/parseint.h>
+#include <android-base/properties.h>
 #include <android/permission/PermissionChecker.h>
 #include <binder/ActivityManager.h>
 #include <binder/AppOpsManager.h>
@@ -96,6 +97,7 @@ namespace {
 
 namespace android {
 
+using base::SetProperty;
 using namespace camera3;
 using namespace camera3::SessionConfigurationUtils;
 
@@ -4319,6 +4321,17 @@ status_t CameraService::BasicClient::startCameraOps() {
 
     mOpsActive = true;
 
+#ifdef USES_MIUI_CAMERA
+    // Configure miui camera mode
+    if (strcmp(String8(mClientPackageName).string(), "com.android.camera") == 0) {
+        SetProperty("sys.camera.miui.apk", "1");
+        ALOGI("Enabling miui camera mode");
+    } else {
+        SetProperty("sys.camera.miui.apk", "0");
+        ALOGI("Disabling miui camera mode");
+    }
+#endif
+
     // Transition device availability listeners from PRESENT -> NOT_AVAILABLE
     sCameraService->updateStatus(StatusInternal::NOT_AVAILABLE, mCameraIdStr);
 
-- 
2.46.0

