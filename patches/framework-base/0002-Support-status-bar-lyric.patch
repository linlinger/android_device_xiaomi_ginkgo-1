From 131f5152142d4b1318aee9ecfb6e568e24557084 Mon Sep 17 00:00:00 2001
From: linlinger <32541118+linlinger@users.noreply.github.com>
Date: Sat, 6 Apr 2024 01:15:08 +0800
Subject: [PATCH 2/2] Support status bar lyric

Change-Id: I7c91875cb69809c07df92de7a5787b5138250b17
---
 packages/SystemUI/res/layout/status_bar.xml   |  1 -
 .../systemui/statusbar/StatusBarIconView.java |  7 ++----
 .../fragment/CollapsedStatusBarFragment.java  | 23 +++++++++++--------
 3 files changed, 15 insertions(+), 16 deletions(-)

diff --git a/packages/SystemUI/res/layout/status_bar.xml b/packages/SystemUI/res/layout/status_bar.xml
index 09902cc0a0c0..999dac9ae773 100644
--- a/packages/SystemUI/res/layout/status_bar.xml
+++ b/packages/SystemUI/res/layout/status_bar.xml
@@ -159,5 +159,4 @@
             </com.android.keyguard.AlphaOptimizedLinearLayout>
         </FrameLayout>
     </LinearLayout>
-
 </com.android.systemui.statusbar.phone.PhoneStatusBarView>
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarIconView.java b/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarIconView.java
index 3c2b05732d01..b1b6c36211af 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarIconView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarIconView.java
@@ -685,12 +685,9 @@ public class StatusBarIconView extends AnimatedImageView implements StatusIconDi
     }
 
     private void initializeDecorColor() {
-        setDecorColor(getContext().getColor(mNightMode
-            setDecorColor(getContext().getColor(mNightMode
-                ? com.android.internal.R.color.notification_default_color_dark
-                    ? com.android.internal.R.color.notification_default_color_dark
+    	setDecorColor(getContext().getColor(mNightMode
+        	? com.android.internal.R.color.notification_default_color_dark
                 : com.android.internal.R.color.notification_default_color_light));
-                    : com.android.internal.R.color.notification_default_color_light)); 
     }
 
     private void updateDecorColor() {
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/fragment/CollapsedStatusBarFragment.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/fragment/CollapsedStatusBarFragment.java
index 77f1335423c9..3c6a21d2a1a9 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/fragment/CollapsedStatusBarFragment.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/fragment/CollapsedStatusBarFragment.java
@@ -72,6 +72,7 @@ import com.android.systemui.statusbar.pipeline.shared.ui.viewmodel.CollapsedStat
 import com.android.systemui.statusbar.policy.KeyguardStateController;
 import com.android.systemui.statusbar.window.StatusBarWindowStateController;
 import com.android.systemui.statusbar.window.StatusBarWindowStateListener;
+import com.android.systemui.tuner.TunerService;
 import com.android.systemui.util.CarrierConfigTracker;
 import com.android.systemui.util.CarrierConfigTracker.CarrierConfigChangedListener;
 import com.android.systemui.util.CarrierConfigTracker.DefaultDataSubscriptionChangedListener;
@@ -95,7 +96,7 @@ import java.util.concurrent.Executor;
 @SuppressLint("ValidFragment")
 public class CollapsedStatusBarFragment extends Fragment implements CommandQueue.Callbacks,
         StatusBarStateController.StateListener,
-        SystemStatusAnimationCallback, Dumpable {
+        SystemStatusAnimationCallback, Dumpable, TunerService.Tunable {
 
     public static final String TAG = "CollapsedStatusBarFragment";
     private static final String EXTRA_PANEL_STATE = "panel_state";
@@ -145,6 +146,8 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
     private final DumpManager mDumpManager;
     private final StatusBarWindowStateController mStatusBarWindowStateController;
     private final KeyguardUpdateMonitor mKeyguardUpdateMonitor;
+    
+    private final TunerService mTunerService;
     private LyricController mLyricController;
 
     private List<String> mBlockedIcons = new ArrayList<>();
@@ -209,7 +212,7 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
 
     @SuppressLint("ValidFragment")
     public CollapsedStatusBarFragment(
-            StatusBarFragmentComponent.Factory statusBarFragmentComponentFactory,
+	        StatusBarFragmentComponent.Factory statusBarFragmentComponentFactory,
             OngoingCallController ongoingCallController,
             SystemStatusAnimationScheduler animationScheduler,
             StatusBarLocationPublisher locationPublisher,
@@ -229,11 +232,12 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
             CollapsedStatusBarFragmentLogger collapsedStatusBarFragmentLogger,
             OperatorNameViewController.Factory operatorNameViewControllerFactory,
             SecureSettings secureSettings,
-            @Main Executor mainExecutor,
+            TunerService tunerService,
+	        @Main Executor mainExecutor,
             DumpManager dumpManager,
             StatusBarWindowStateController statusBarWindowStateController,
             KeyguardUpdateMonitor keyguardUpdateMonitor
-    ) {
+		) {
         mStatusBarFragmentComponentFactory = statusBarFragmentComponentFactory;
         mOngoingCallController = ongoingCallController;
         mAnimationScheduler = animationScheduler;
@@ -258,6 +262,7 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
         mDumpManager = dumpManager;
         mStatusBarWindowStateController = statusBarWindowStateController;
         mKeyguardUpdateMonitor = keyguardUpdateMonitor;
+	mTunerService = tunerService;
     }
 
     @Override
@@ -319,7 +324,7 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
         mCarrierConfigTracker.addDefaultDataSubscriptionChangedListener(mDefaultDataListener);
         mCollapsedStatusBarViewBinder.bind(
                 mStatusBar, mCollapsedStatusBarViewModel, mStatusBarVisibilityChangeListener);
-        mTunerService.addTunable(this, STATUS_BAR_SHOW_LYRIC);
+	mTunerService.addTunable(this, STATUS_BAR_SHOW_LYRIC);
     }
 
     @Override
@@ -396,7 +401,8 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
     @Override
     public void onDestroyView() {
         super.onDestroyView();
-        mStatusBarIconController.removeIconGroup(mDarkIconManager);
+        mTunerService.removeTunable(this);
+	mStatusBarIconController.removeIconGroup(mDarkIconManager);
         mCarrierConfigTracker.removeCallback(mCarrierConfigCallback);
         mCarrierConfigTracker.removeDataSubscriptionChangedListener(mDefaultDataListener);
 
@@ -413,7 +419,7 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
             case STATUS_BAR_SHOW_LYRIC:
                 if (mLyricController != null) {
                     boolean enable = TunerService.parseIntegerSwitch(newValue, false);
-                    mLyricController.setEnabled(enable);
+                  mLyricController.setEnabled(enable);
                 }
                 break;
             default:
@@ -850,7 +856,6 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
         public LyricController(Context context, View statusBar) {
             super(context, statusBar);
             mLeftSide = statusBar.findViewById(R.id.status_bar_start_side_except_heads_up);
-            mCenteredArea = statusBar.findViewById(R.id.centered_area);
         }
 
         public void showLyricView(boolean animate) {
@@ -860,7 +865,6 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
             boolean hasOngoingCall = visibilityModel.getShowOngoingCallChip();
             if (!disableNotifications && !hasOngoingCall && isLyricStarted()) {
                 animateHide(mLeftSide, animate);
-                animateHide(mCenteredArea, animate);
                 animateShow(getView(), animate);
             }
         }
@@ -868,7 +872,6 @@ public class CollapsedStatusBarFragment extends Fragment implements CommandQueue
         public void hideLyricView(boolean animate) {
             animateHide(getView(), animate);
             animateShow(mLeftSide, animate);
-            animateShow(mCenteredArea, animate);
         }
     }
 }
-- 
2.34.1

